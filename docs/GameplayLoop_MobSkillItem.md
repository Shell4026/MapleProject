# 전투/몬스터/아이템 루프 기술 문서

## 개요
이 문서는 서버 권한 기반으로 동작하는 몬스터 AI, 피격/사망, 드롭, 클라이언트 동기화까지의 게임플레이 루프를 설명합니다.

---

## 몬스터 스폰/리스폰

`MobSpawner`는 다음 흐름으로 동작합니다.

1. 초기화 시 스폰 후보 인덱스를 큐에 적재
2. `mobLimit`과 현재 생존 수를 비교
3. 부족한 수만큼 큐에서 꺼내 활성화
4. `MobSpawnPacket` 브로드캐스트
5. 개별 몬스터 상태 패킷 즉시 송신

몬스터 사망 이벤트를 받으면 해당 인덱스를 다시 큐에 넣어, 지연 스폰(`spawnDelayMs`) 기반 리스폰을 수행합니다.

---

## 몬스터 AI/상태 전송

### AI
`BasicAI`는 FSM으로 동작합니다.

- Idle: 대기
- Move: 랜덤 이동
- Chase: 타겟 추격

상태 전이는 타이머/랜덤/타겟 유효성 기반으로 결정됩니다.

### 상태 전송
`Mob`은 약 0.1초 주기로(`10Hz`) 상태를 네트워크로 송신합니다.

- 위치/속도
- HP
- Stun 여부와 잔여 시간
- AI state 값
- 스냅샷 시퀀스

피격 직후에는 즉시 전송을 유도해 타격 반응 지연을 줄입니다.

---

## 스킬 처리 파이프라인

1. 클라이언트가 스킬 입력 패킷 전송 (`SkillUsingPacket`)
2. 서버 `EntityRouter`가 플레이어 `SkillManager`로 전달
3. `SkillManager`가 시퀀스 중복 검사 후 발동
4. 쿨타임/상태 변경 적용
5. 투사체/히트박스 충돌은 서버 물리에서 판정

즉, **입력은 클라에서 시작하지만 판정은 서버가 확정**합니다.

---

## 피격/사망/드롭

### 피격
- 몹 콜라이더가 `ProjectileHitBox`와 충돌 시 소유자 검사
- 플레이어 소유 투사체이면 데미지/스턴 적용
- 넉백 impulse 적용

### 사망
- HP 0이면 사망 이벤트 발행
- 몹 비활성화 + 상태 패킷 송신
- 드롭 테이블(`itemDrop.json`) 기반 확률 드랍 계산

### 드롭 아이템
- 서버 월드가 아이템 오브젝트 재사용/활성화
- `ItemDropPacket` 브로드캐스트
- 클라이언트는 item DB 정보로 텍스처/오브젝트 구성
- 회수/소멸 시 `ItemDespawnPacket`으로 정리

---

## 확장 포인트

- AI 전략 교체(`AIStrategy`)로 몬스터 패턴 다변화
- 드롭 테이블 JSON 확장으로 컨텐츠 추가
- 상태 패킷 주기/압축 정책 조정으로 대역폭 최적화
- 스킬별 판정 방식을 서버 컴포넌트 단위로 분리 가능

---

## 요약

이 루프는

- **서버 권한 판정**
- **이벤트 기반 리스폰/드롭**
- **주기 + 즉시 송신 혼합 동기화**

를 통해 실시간 액션성과 멀티플레이 정합성을 동시에 만족시키도록 설계되어 있습니다.
