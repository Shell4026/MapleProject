# MapleProject Technical Overview

> 포트폴리오용 기술 문서입니다.  
> README의 요약 내용을 확장해, 실제 코드 구조/설계 의도를 중심으로 정리했습니다.

---

## 1. 프로젝트 목표와 방향

이 프로젝트는 단순한 기능 구현보다, **실시간 멀티플레이에서 중요한 설계 선택**을 검증하는 데 초점을 둡니다.

- 서버 권한(authoritative) 구조 유지
- 네트워크 지연 환경에서도 조작감 유지
- 월드/인벤토리 상태를 안정적으로 동기화
- 시스템 간 결합도를 낮춰 확장성 확보

---

## 2. 빌드/코드 구조

### 2.1 타겟 분리
- Client DLL: `Source/client + Source/common`
- Server DLL: `Source/server + Source/common`
- `SH_SERVER` 매크로로 서버 전용 코드 분기

공통 도메인 로직은 재사용하고, 런타임 책임은 클라/서버로 분리한 구조입니다.

### 2.2 주요 컴포넌트
- `MapleClient`
  - UDP/TCP 수신 처리
  - 서버 연결 및 패킷 송신
  - 로컬 유저 상태 관리
- `MapleServer`
  - UDP 처리 + TCP 리스너 운영
  - 유저 접속/퇴장, 월드 로딩
  - 브로드캐스트 및 이벤트 발행
- `MapleWorld` (클라/서버 별도 구현)
  - 서버: 플레이어 스폰/디스폰, 아이템 드랍/정리, 월드 tick
  - 클라: 스폰 패킷 기반 오브젝트 생성, 카메라 로컬 바인딩

---

## 3. 네트워크 설계

## 3.1 UDP + TCP 하이브리드
- UDP: 위치/상태처럼 고빈도, 일부 손실 허용 데이터
- TCP: 인벤토리/월드 전환처럼 신뢰성 필수 데이터

## 3.2 접속 시퀀스
1. 클라이언트가 `PlayerJoinPacket`(UDP) 송신
2. 서버가 토큰(`PlayerTokenPacket`) 발급
3. 클라가 TCP 연결 후 토큰 전송
4. 서버가 pending TCP 소켓과 토큰을 매칭해 세션 확정

UDP endpoint와 TCP 연결을 안전하게 귀속시키기 위한 절차입니다.

## 3.3 생존성 관리
- 클라: 주기적 heartbeat 전송
- 서버: heartbeat 감소/검사 후 timeout 유저 정리

비정상 종료 시에도 유저/월드 엔티티를 정리할 수 있게 구성했습니다.

---

## 4. 동기화와 게임플레이 루프

## 4.1 플레이어 동기화
- 월드 진입 유저에게 기존 플레이어 목록 선전송
- 신규 플레이어 생성 후 기존 유저에게 브로드캐스트
- 본인에게는 `bLocal=true` 상태를 별도로 전달해 카메라와 입력 주체를 명확히 구분

## 4.2 아이템 라이프사이클
- 드랍 시 패킷 브로드캐스트 + 월드 엔티티 활성화
- 소멸 시 비활성화 후 sleep 큐에 적재
- 장시간 미사용 객체는 정리하여 메모리 회수

즉시 destroy만 반복하지 않고 재사용을 섞어 성능 비용을 완화했습니다.

---

## 5. 플레이어 이동 핵심: Prediction/Reconciliation

핵심 아이디어:
- 클라가 입력 즉시 예측 이동
- 서버가 권한 상태를 주기적으로 제공
- 클라가 과거 입력 버퍼를 기준으로 오차 보정 후 재시뮬레이션

또한 foothold(선 기반 지형) 시스템으로 결정적 재현 안정성을 높였습니다.

상세 알고리즘/비교 실험은 별도 문서 참조:
- [`PlayerPrediction.md`](./PlayerPrediction.md)

---

## 6. 데이터 영속화: SQLite + DBThread

- `users.db` 사용
- DB 접근은 전용 워커 스레드(`DBThread`)에서 비동기 처리
- 로그인 시 유저 조회/생성, 접속 정보 업데이트, 인벤토리 로드

### 인벤토리 최적화 포인트
- 슬롯 기반 인벤토리(기본 32칸)
- dirty slot 추적으로 변경분만 동기화
- DB 저장은 트랜잭션 단위로 처리

네트워크 대역폭과 DB write 횟수를 동시에 줄이기 위한 설계입니다.

---

## 7. 포트폴리오 관점 핵심 어필 포인트

- 서버 권한 동기화와 클라 체감 품질 사이의 균형 설계
- UDP/TCP 책임 분리
- EventBus/Router로 결합도 완화
- 비동기 DB 파이프라인 적용
- 실시간 게임에서 중요한 “상태 일관성 + 반응성” 동시 확보 시도

